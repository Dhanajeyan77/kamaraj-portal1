{% extends "layout.html" %}

{% block content %}
<style>
    /* ==========================================
       1. GLOBAL LAYOUT & SPACING
       Optimized for high-density student portals
       ========================================== */
    .coding-environment {
        padding: 20px;
        background-color: #f3f4f6;
        min-height: calc(100vh - 80px);
        font-family: 'Inter', system-ui, sans-serif;
    }

    /* Container for the side-by-side view */
    .coding-environment .split-container {
        display: flex;
        gap: 16px; 
        min-height: 85vh; 
        max-width: 1550px;
        margin: 0 auto;
    }

    /* ==========================================
       2. DESCRIPTION SIDE (LEFT PANE)
       ========================================== */
    .coding-environment .description-side {
        flex: 1; /* Approximately 40% width */
        background: white;
        padding: 30px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        overflow-y: auto;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    /* Header for the question */
    .coding-environment h2 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 8px;
    }

    .difficulty-tag {
        display: inline-block;
        background: #fef3c7;
        color: #d97706; 
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        margin-bottom: 12px;
        text-transform: uppercase;
    }

    /* Body text for the problem */
    .coding-environment .content-body {
        line-height: 1.8;
        font-size: 1rem;
        color: #374151;
        white-space: pre-wrap;
    }

    /* ==========================================
       3. EDITOR SIDE (RIGHT PANE)
       ========================================== */
    .coding-environment .editor-side {
        flex: 1.5; /* Approximately 60% width */
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* --- RESPONSIVE MOBILE OVERRIDE --- */
    @media (max-width: 1024px) {
        .coding-environment .split-container {
            flex-direction: column; 
            height: auto;
        }
        .coding-environment .description-side, 
        .coding-environment .editor-side {
            width: 100%;
            flex: none; 
        }
        .coding-environment .terminal {
            height: 300px !important;
        }
    }

    /* --- LAPTOP VIEW FIXES --- */
    @media (min-width: 1025px) {
        .coding-environment #editor {
            min-height: 480px !important; 
        }
        .coding-environment .terminal {
            min-height: 350px !important; 
            flex-grow: 1;
        }
    }

    /* ==========================================
       4. EDITOR COMPONENTS
       ========================================== */
    .coding-environment .editor-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #1f2937;
        padding: 12px 20px;
        border-radius: 10px 10px 0 0;
    }

    .coding-environment .lang-select-dropdown {
        background: #374151;
        color: #10b981;
        border: 1px solid #4b5563;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 600;
        outline: none;
        cursor: pointer;
    }

    /* The Code Editor Box */
    .coding-environment #editor {
        width: 100%;
        background: #0f172a;
        color: #f8fafc;
        font-family: 'Fira Code', 'Cascadia Code', 'Source Code Pro', monospace;
        padding: 25px;
        border: 1px solid #1e293b;
        border-radius: 0;
        font-size: 1.05rem;
        line-height: 1.6;
        outline: none;
        resize: none;
    }

    .coding-environment .run-btn {
        background: #10b981;
        color: white;
        padding: 8px 24px;
        border: none;
        border-radius: 6px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }

    .coding-environment .run-btn:hover { 
        background: #059669; 
        transform: translateY(-1px); 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* ==========================================
       5. TERMINAL / CONSOLE SECTION
       ========================================== */
    .coding-environment .terminal {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 0 0 10px 10px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .coding-environment .terminal-nav {
        background: #f9fafb;
        color: #4b5563;
        padding: 10px 20px;
        font-weight: 700;
        font-size: 0.85rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .coding-environment .output-text {
        padding: 20px;
        color: #111827;
        font-family: 'Fira Code', monospace;
        font-size: 0.95rem;
        margin: 0;
    }

    /* Rules section */
    .coding-rules {
        margin-top: 30px; 
        padding: 20px; 
        background: #f9fafb; 
        border-left: 5px solid #10b981; 
        border-radius: 8px;
    }
</style>

<div class="coding-environment">
    <div class="split-container">
        
        <div class="description-side">
            <span class="difficulty-tag">Coding Challenge</span>
            <h2>{{ question.title }}</h2>
            <p style="color: #6b7280; font-size: 0.85rem; margin-bottom: 20px;">üìÖ Challenge Date: {{ question.date }}</p>
            
            <hr style="border: 0; border-top: 1px solid #f3f4f6; margin-bottom: 25px;">
            
            <div class="content-body">
                {{ question.content }}
            </div>

            <div class="coding-rules">
                <p style="font-weight: 800; color: #111827; margin-bottom: 10px;">üìã Submission Rules:</p>
                <div id="python-rules" style="font-size: 0.9rem;">
                    ‚Ä¢ <b>Python:</b> Use <code>input_val</code> and assign the result to <code>output_val</code>.<br>
                    ‚Ä¢ <b>Academic Integrity:</b> No copy-pasting allowed.
                </div>
                <div id="java-rules" style="display:none; font-size: 0.9rem;">
                    ‚Ä¢ <b>Java:</b> Use <code>args[0]</code> and print via <code>System.out.println()</code>.
                </div>
            </div>
        </div>

        <div class="editor-side">
            <form method="POST" id="submission-form" style="display:contents;">
                <div class="editor-controls">
                    <div>
                        <select name="lang_choice" id="lang_choice" class="lang-select-dropdown">
                            <option value="python">Python 3.11</option>
                            <option value="java">Java 21</option>
                        </select>
                    </div>
                    <button type="submit" class="run-btn">Run & Submit Code</button>
                </div>
                
                <div id="java-info" style="display:none; background:#fffbeb; color:#92400e; padding:10px 20px; font-size:0.85rem; border-bottom:1px solid #fde68a;">
                    ‚ö†Ô∏è <b>Java Rule:</b> Your main class must be named <b>Solution</b>.
                </div>

                <textarea name="user_code" id="editor" spellcheck="false" placeholder="# Start your implementation here...">{{ user_code if user_code else "" }}</textarea>
            </form>

            <div class="terminal">
                <div class="terminal-nav">Execution Console</div>
                <div class="output-text">
                    {% if output %}
                        <div style="color: #065f46; font-weight: 600;">{{ output }}</div>
                    {% else %}
                        <div style="color: #9ca3af;">System ready. Waiting for student code...</div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    /**
     * DOM Readiness handler
     * Manages Editor features and Anti-Cheating logic
     */
    document.addEventListener('DOMContentLoaded', function() {
        const editor = document.getElementById('editor');
        const terminal = document.querySelector('.terminal');
        const langSelect = document.getElementById('lang_choice');
        const javaInfo = document.getElementById('java-info');
        const pythonRules = document.getElementById('python-rules');
        const javaRules = document.getElementById('java-rules');

        // --- 1. LANGUAGE TOGGLE LOGIC ---
        langSelect.addEventListener('change', function() {
            if (this.value === 'java') {
                javaInfo.style.display = 'block';
                javaRules.style.display = 'block';
                pythonRules.style.display = 'none';
            } else {
                javaInfo.style.display = 'none';
                javaRules.style.display = 'none';
                pythonRules.style.display = 'block';
            }
        });

        // --- 2. EDITOR BEHAVIOR (Indentation & Tabs) ---
        editor.addEventListener('keydown', function(e) {
            // Handle Tab Key for 4-space indentation
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                this.value = this.value.substring(0, start) + "    " + this.value.substring(this.selectionEnd);
                this.selectionStart = this.selectionEnd = start + 4;
            }
            
            // Handle Smart Enter for automatic indentation
            if (e.key === 'Enter') {
                e.preventDefault();
                const start = this.selectionStart;
                const lines = this.value.substring(0, start).split('\n');
                const currentLine = lines[lines.length - 1];
                const whitespace = currentLine.match(/^(\s*)/)[0];
                let extra = (currentLine.trim().endsWith(':') || currentLine.trim().endsWith('{')) ? "    " : "";
                const insertion = "\n" + whitespace + extra;
                this.value = this.value.substring(0, start) + insertion + this.value.substring(start);
                this.selectionStart = this.selectionEnd = start + insertion.length;
            }
        });

        // --- 3. ANTI-CHEATING SUITE ---
        // Block standard keyboard paste
        editor.addEventListener('paste', function(e) {
            e.preventDefault();
            alert("‚ö†Ô∏è Academic Integrity: Manual typing is required for this lab.");
        });

        // Block standard cut operation
        editor.addEventListener('cut', function(e) {
            e.preventDefault();
            alert("‚ö†Ô∏è Cut operation disabled.");
        });

        // Block Right-Click Context Menu to prevent mouse-pasting
        editor.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            alert("‚ö†Ô∏è Right-click disabled in the coding environment.");
        });
        
        // Handle Mobile/Advanced Pasting detection
        editor.addEventListener('input', function(e) {
            // Detects large text blocks inserted at once
            if (e.inputType === 'insertFromPaste' || (e.data && e.data.length > 25)) {
                this.value = ""; 
                alert("‚ö†Ô∏è External code detected. Editor has been cleared.");
            }
        });

        // Keep terminal scrolled to the bottom on page load
        if (terminal) { 
            terminal.scrollTop = terminal.scrollHeight; 
        }
    });
</script>
{% endblock %}