{% extends "layout.html" %}

{% block content %}
<style>
    /* ==========================================
       1. GLOBAL THEME & GRID
       ========================================== */
    :root {
        --lc-green: #2db55d;
        --lc-orange: #ffa116;
        --lc-border: #e2e8f0;
        --editor-bg: #0d1117;
    }

    .coding-environment {
        padding: 20px;
        background-color: #f0f2f5;
        height: calc(100vh - 80px); 
        display: flex;
        flex-direction: column;
        overflow: hidden; 
        font-family: 'Inter', -apple-system, sans-serif;
    }

    /* Anti-Cheating Alert Overlay */
    #cheating-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85);
        color: white;
        z-index: 9999;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }

    .split-container {
        display: flex;
        gap: 16px; 
        flex: 1;
        max-width: 1850px;
        margin: 0 auto;
        width: 100%;
        overflow: hidden; 
    }

    /* LEFT PANE: PROBLEM DESCRIPTION */
    .description-side {
        flex: 1;
        background: #ffffff;
        padding: 35px;
        border-radius: 12px;
        border: 1px solid var(--lc-border);
        overflow-y: auto; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
    }

    .description-side h2 {
        font-size: 1.85rem;
        font-weight: 800;
        color: #1a1a1a;
        margin-bottom: 12px;
    }

    .difficulty-tag {
        display: inline-flex;
        background: #fff7ed;
        color: var(--lc-orange); 
        padding: 5px 14px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 25px;
        width: fit-content;
    }

    .content-body {
        line-height: 1.8;
        font-size: 1.05rem;
        color: #374151;
        white-space: pre-wrap;
    }

    /* INSTRUCTION DESIGN */
    .setup-instructions {
        margin-top: 30px;
        padding: 25px;
        background: #f0fdf4;
        border-left: 8px solid var(--lc-green);
        border-radius: 12px;
    }

    .setup-instructions h4 {
        color: #166534;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.15rem;
    }

    .setup-instructions li {
        margin-bottom: 10px;
        color: #14532d;
        font-size: 0.95rem;
        list-style: none;
    }

    .setup-instructions code {
        background: #d1fae5;
        color: #065f46;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 700;
        font-family: 'Fira Code', monospace;
    }

    .test-case-info {
        margin-top: 20px;
        padding: 20px;
        background: #f8fafc;
        border: 1px solid var(--lc-border);
        border-radius: 12px;
    }

    /* RIGHT PANE: EDITOR & TERMINAL */
    .editor-side {
        flex: 1.6; 
        display: flex;
        flex-direction: column;
        gap: 12px;
        height: 100%;
    }

    .editor-wrapper {
        flex: 2.8; 
        display: flex;
        flex-direction: column;
        background: #1e1e1e;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #333;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .editor-header {
        background: #2d2d2d;
        padding: 12px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #editor {
        flex: 1;
        width: 100%;
        background: var(--editor-bg);
        color: #e6edf3;
        font-family: 'Fira Code', 'Cascadia Code', monospace;
        padding: 25px;
        border: none;
        font-size: 1.1rem;
        line-height: 1.6;
        outline: none;
        resize: none;
    }

    /* TERMINAL */
    .terminal {
        flex: 0.9; 
        background: white;
        border: 2px solid var(--lc-border);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        margin-bottom: 40px; 
    }

    .terminal-header {
        background: #f8fafc;
        padding: 10px 24px;
        font-weight: 800;
        font-size: 0.85rem;
        color: #475569;
        border-bottom: 1px solid var(--lc-border);
    }

    .output-text {
        padding: 20px;
        font-family: 'Fira Code', monospace;
        font-size: 1rem;
        white-space: pre-wrap; 
        overflow-y: auto;
    }

    .status-success { color: #16a34a; font-weight: 800; }
    .status-failed { color: #dc2626; font-weight: 800; }

    .run-btn {
        background: var(--lc-green);
        color: white;
        padding: 10px 30px;
        border-radius: 8px;
        font-weight: 800;
        border: none;
        cursor: pointer;
    }

    .footer-guard {
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f0f2f5;
        font-size: 0.8rem;
        color: #94a3b8;
    }
</style>

<div id="cheating-overlay">
    <h1 style="font-size: 3rem;">‚ö†Ô∏è WARNING</h1>
    <p style="font-size: 1.5rem; max-width: 600px;">Switching tabs or screens is strictly prohibited during the assessment. Your activity has been logged.</p>
    <button onclick="document.getElementById('cheating-overlay').style.display='none'" class="run-btn" style="margin-top: 20px;">Return to Test</button>
</div>

<div class="coding-environment" oncontextmenu="return false;"> <div class="split-container">
        
        <div class="description-side">
            <div class="difficulty-tag">Challenge 2026</div>
            <h2>{{ question.title }}</h2>
            <hr style="border: 0; border-top: 1px solid #f1f5f9; margin-bottom: 25px;">
            <div class="content-body">{{ question.content }}</div>

            <div class="setup-instructions">
                <h4>üöÄ How Your Code Is Executed:</h4>
                <div id="lang-instructions"></div>
            </div>

            <div class="test-case-info">
                <h4 style="color:#334155; margin-bottom:10px;">üìä Test Case Policy</h4>
                <ul style="padding-left: 20px; font-size: 0.9rem; color: #475569;">
                    <li>Inputs are hidden and stored in the database.</li>
                    <li>Program will run against multiple test cases via STDIN.</li>
                    <li>Output must match expected output exactly.</li>
                </ul>
            </div>
        </div>

        <div class="editor-side">
            <form method="POST" id="submission-form" class="editor-wrapper">
                <div class="editor-header">
                    <select name="lang_choice" id="lang_choice" style="background:#444; color:#fff; border:none; padding:6px 12px; border-radius:6px; font-weight:700;">
                        <option value="python">Python 3.11</option>
                        <option value="cpp">C++ 20</option>
                        <option value="c">C (GCC 13)</option>
                        <option value="java">Java 21</option>
                        <option value="javascript">JavaScript (Node.js)</option> </select>
                    <button type="submit" class="run-btn">Run & Submit</button>
                </div>
                <textarea name="user_code" id="editor" spellcheck="false" autocomplete="off" onpaste="return false">{{ user_code if user_code else "" }}</textarea>
            </form>

            <div class="terminal">
                <div class="terminal-header">
                    <span style="color:var(--lc-green)">‚óè</span> Execution Console Result
                </div>
                <div class="output-text" id="terminal-output">
                    {% if output %}
                        <div class="{% if 'FAILED' in output %}status-failed{% else %}status-success{% endif %}">
                            {% if 'FAILED' in output %}‚ùå FAILED{% else %}‚úÖ SUCCESS{% endif %}
                        </div>
                        <div style="margin-top: 8px;">{{ output }}</div>
                    {% else %}
                        <span style="color: #94a3b8; font-style: italic;">Awaiting student code results...</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="footer-guard">
        ¬© 2026 Kamaraj College - Computer Science Department
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editor = document.getElementById('editor');
        const langSelect = document.getElementById('lang_choice');
        const instContainer = document.getElementById('lang-instructions');
        const cheatingOverlay = document.getElementById('cheating-overlay');

        /* --- ANTI-CHEATING: TAB SWITCHING --- */
        let tabSwitchCount = 0;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                tabSwitchCount++;
                console.warn(`Tab switched ${tabSwitchCount} times`);
                cheatingOverlay.style.display = 'flex';
            }
        });

        /* --- ANTI-CHEATING: PREVENT KEYBOARD COPY/PASTE --- */
        editor.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'v' || e.key === 'V')) {
                e.preventDefault();
                alert("Pasting code is not allowed!");
            }
            if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C')) {
                e.preventDefault();
                alert("Copying code is not allowed!");
            }
        });

        const configs = {
            python: {
                inst: `<li>‚Ä¢ Read input using <code>input()</code></li><li>‚Ä¢ Print output using <code>print()</code></li>`,
                code: "import sys\n\ndef main():\n    # s = input()\n    # print(s)\n    pass\n\nif __name__ == '__main__':\n    main()"
            },
            java: {
                inst: `<li>‚Ä¢ Class name must be <strong>Solution</strong></li><li>‚Ä¢ Use <code>Scanner(System.in)</code></li><li>‚Ä¢ Entry: <code>public static void main(String[] args)</code></li>`,
                code: "import java.util.*;\n\npublic class Solution {\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        // Write your logic here\n    }\n}"
            },
            cpp: {
                inst: `<li>‚Ä¢ Entry point: <code>int main()</code></li><li>‚Ä¢ Use <code>cin</code> and <code>cout</code></li>`,
                code: "#include <iostream>\nusing namespace std;\n\nint main() {\n    // Write your logic here\n    return 0;\n}"
            },
            c: {
                inst: `<li>‚Ä¢ Entry point: <code>int main()</code></li><li>‚Ä¢ Use <code>scanf</code> and <code>printf</code></li>`,
                code: "#include <stdio.h>\n\nint main() {\n    // Write your logic here\n    return 0;\n}"
            },
            javascript: {
                inst: `<li>‚Ä¢ Read input using <code>fs.readFileSync(0, "utf8")</code></li><li>‚Ä¢ Output using <code>console.log</code></li>`,
                code: "const fs = require('fs');\nconst input = fs.readFileSync(0, 'utf8');\n\nfunction solve(input) {\n    // Write your logic here\n}\n\nsolve(input);"
            }
        };

        // Update Editor and Instructions
        function updateEnv(lang) {
            instContainer.innerHTML = configs[lang].inst;
            editor.value = configs[lang].code;
        }

        langSelect.addEventListener('change', (e) => updateEnv(e.target.value));

        /* --- EDITOR FUNCTIONALITY: INDENTATION --- */
        editor.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + "    " + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 4;
            }

            if (e.key === 'Enter') {
                e.preventDefault();
                const start = this.selectionStart;
                const textBefore = this.value.substring(0, start);
                const currentLine = textBefore.split('\n').pop();
                const whitespace = currentLine.match(/^(\s*)/)[0];
                
                let extra = (currentLine.trim().endsWith(':') || currentLine.trim().endsWith('{')) ? "    " : "";
                const insertText = "\n" + whitespace + extra;
                
                this.value = this.value.substring(0, start) + insertText + this.value.substring(start);
                this.selectionStart = this.selectionEnd = start + insertText.length;
            }
        });

        if(!editor.value.trim()) updateEnv(langSelect.value);
        else instContainer.innerHTML = configs[langSelect.value].inst;

        const term = document.getElementById('terminal-output');
        if (term) term.scrollTop = term.scrollHeight;
    });
</script>
{% endblock %}