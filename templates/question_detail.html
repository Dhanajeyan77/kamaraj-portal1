{% extends "layout.html" %}

{% block content %}
<style>
    /* 1. Global Layout & Scoping */
    .coding-environment {
        padding: 15px;
        background-color: #f1f5f9;
        min-height: calc(100vh - 80px);
        font-family: 'Inter', system-ui, sans-serif;
    }

    .coding-environment .split-container {
        display: flex;
        gap: 20px;
        /* Changed height to auto for flexibility on mobile */
        min-height: 82vh; 
        max-width: 100%;
        margin: 0 auto;
    }

    /* 2. Left Side: Problem Description */
    .coding-environment .description-side {
        flex: 1;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        border: 1px solid #e2e8f0;
    }

    /* 3. Right Side: Editor Section */
    .coding-environment .editor-side {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    /* --- RESPONSIVE MOBILE OVERRIDE --- */
    @media (max-width: 992px) {
        .coding-environment .split-container {
            flex-direction: column; /* Stacks description and editor */
            height: auto;
        }

        .coding-environment .description-side, 
        .coding-environment .editor-side {
            width: 100%;
            flex: none; /* Disables equal splitting for mobile */
        }

        .coding-environment .terminal {
            height: 250px; /* Gives more room for output on small screens */
        }
        
        .coding-environment .editor-controls {
            flex-wrap: wrap; /* Prevents button overlap on small phones */
            gap: 10px;
        }
    }

    /* Keep all your other styles exactly as they were */
    .coding-environment .problem-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .coding-environment .content-body {
        white-space: pre-wrap;
        line-height: 1.6;
        font-size: 0.95rem;
        color: #1e293b;
    }

    .coding-rules {
        margin-top: 20px;
        padding: 15px;
        background: #f8fafc;
        border-left: 4px solid #10b981;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .coding-rules code {
        background: #e2e8f0;
        padding: 2px 4px;
        border-radius: 3px;
        color: #0f172a;
    }

    .coding-environment .editor-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #1e293b;
        padding: 10px 20px;
        border-radius: 12px 12px 0 0;
        color: white;
    }

    .coding-environment .lang-select-dropdown {
        background: #334155;
        color: #4ade80;
        border: 1px solid #475569;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        outline: none;
    }

    #java-info {
        display: none;
        background: #fef3c7;
        color: #92400e;
        padding: 8px 20px;
        font-size: 0.85rem;
        border-bottom: 1px solid #fde68a;
    }

    .coding-environment #editor {
        width: 100%;
        min-height: 400px; /* Ensures editor stays visible when stacked */
        background: #0f172a;
        color: #f1f5f9;
        font-family: 'Fira Code', 'Cascadia Code', monospace;
        padding: 20px;
        border: none;
        resize: vertical;
        font-size: 1rem;
        outline: none;
    }

    .coding-environment .run-btn {
        background: #10b981;
        color: white;
        padding: 8px 20px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }

    .coding-environment .run-btn:hover {
        background: #059669;
    }

    .coding-environment .terminal {
        background: #000;
        border-radius: 0 0 12px 12px;
        height: 180px;
        overflow-y: auto;
        border: 1px solid #1e293b;
    }

    .coding-environment .terminal-nav {
        background: #1e293b;
        color: #94a3b8;
        padding: 5px 15px;
        font-size: 0.75rem;
    }

    .coding-environment .output-text {
        padding: 15px;
        color: #4ade80;
        font-family: monospace;
        margin: 0;
        font-size: 0.9rem;
    }
</style>

<div class="coding-environment">
    <div class="split-container">
        
        <div class="description-side">
            <div class="problem-header">
                <h3 style="margin:0;">{{ question.date }}</h3>
                <span style="background:#f1f5f9; padding:4px 10px; border-radius:15px; font-size:0.8rem; font-weight:600;">Challenge</span>
            </div>
            <hr>
            <div class="content-body">
                <strong>{{ question.title }}</strong><br><br>
                {{ question.content }}
            </div>

            <div class="coding-rules">
                <p><strong>üöÄ Standard I/O Rules:</strong></p>
                <div id="python-rules">
                    ‚Ä¢ <b>Input:</b> Use the variable <code>input_val</code>.<br>
                    ‚Ä¢ <b>Output:</b> Assign your result to <code>output_val</code>.
                </div>
                <div id="java-rules" style="display:none;">
                    ‚Ä¢ <b>Input:</b> Access via <code>args[0]</code>.<br>
                    ‚Ä¢ <b>Output:</b> Use <code>System.out.println()</code>.
                </div>
            </div>
        </div>

        <div class="editor-side">
            <form method="POST" id="submission-form" style="display:contents;">
                <div class="editor-controls">
                    <div>
                        <label style="font-size: 0.8rem; margin-right: 5px; color: #94a3b8;">Language:</label>
                        <select name="lang_choice" id="lang_choice" class="lang-select-dropdown">
                            <option value="python">Python 3.11</option>
                            <option value="java">Java 21</option>
                        </select>
                    </div>
                    <button type="submit" class="run-btn">Run & Submit</button>
                </div>
                
                <div id="java-info">
                    ‚ö†Ô∏è <b>Java Rule:</b> Class name must be <code>Solution</code>
                </div>

                <textarea name="user_code" id="editor" placeholder="# Write your code here...">{{ user_code if user_code else "" }}</textarea>
            </form>

            {% if output %}
            <div class="terminal">
                <div class="terminal-nav">Execution Result</div>
                <pre class="output-text">{{ output }}</pre>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<script>
// All your existing JS logic (Tab, Enter, Anti-cheating) stays here...
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('editor');
    const langSelect = document.getElementById('lang_choice');
    const javaInfo = document.getElementById('java-info');
    const pythonRules = document.getElementById('python-rules');
    const javaRules = document.getElementById('java-rules');
    const terminal = document.querySelector('.terminal');

    editor.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.substring(0, start) + "    " + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 4;
        }

        if (e.key === 'Enter') {
            e.preventDefault();
            const start = this.selectionStart;
            const textBeforeCaret = this.value.substring(0, start);
            const lines = textBeforeCaret.split('\n');
            const currentLine = lines[lines.length - 1];
            const matches = currentLine.match(/^(\s*)/);
            const whitespace = matches ? matches[0] : "";
            let extraIndent = "";
            if (currentLine.trim().endsWith(':') || currentLine.trim().endsWith('{')) {
                extraIndent = "    ";
            }
            const insertion = "\n" + whitespace + extraIndent;
            this.value = this.value.substring(0, start) + insertion + this.value.substring(start);
            this.selectionStart = this.selectionEnd = start + insertion.length;
        }
    });

    langSelect.addEventListener('change', function() {
        if (this.value === 'java') {
            javaInfo.style.display = 'block';
            javaRules.style.display = 'block';
            pythonRules.style.display = 'none';
            if (editor.value.trim() === "" || editor.value.includes("# Write your code here")) {
                editor.value = "public class Solution {\n    public static void main(String[] args) {\n        String input_val = args[0];\n        // Write code here\n    }\n}";
            }
        } else {
            javaInfo.style.display = 'none';
            javaRules.style.display = 'none';
            pythonRules.style.display = 'block';
            if (editor.value.includes("public class Solution")) {
                editor.value = "";
            }
        }
    });

    editor.addEventListener('paste', function(e) {
        e.preventDefault();
        alert("‚ö†Ô∏è Copy-pasting is disabled! Please type your solution manually.");
    });

    editor.addEventListener('input', function(e) {
        if (e.inputType === 'insertFromPaste' || (e.data && e.data.length > 30)) {
            editor.value = ""; 
            alert("‚ö†Ô∏è Mobile pasting detected and blocked!");
        }
    });

    editor.addEventListener('cut', function(e) {
        e.preventDefault();
        alert("‚ö†Ô∏è Cutting code is disabled.");
    });

    if (terminal) {
        terminal.scrollTop = terminal.scrollHeight;
    }
});
</script>
{% endblock %}